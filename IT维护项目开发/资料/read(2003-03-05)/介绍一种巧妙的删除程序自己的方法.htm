<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0088)http://www.vchelp.net/vchelp/zart/dels.asp?type_id=26&class_id=1&cata_id=2&article_id=97 -->
<HTML><HEAD><TITLE>VCHelp.net</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type>
<META content=no-cache http-equiv=Pragma>
<STYLE>.trfocus {
	BACKGROUND-COLOR: #ffffff
}
.trfocus2 {
	BACKGROUND-COLOR: #ffff00
}
.trmod0 {
	BACKGROUND-COLOR: #f0f0f0
}
.trmod1 {
	BACKGROUND-COLOR: #e6e6e6
}
A {
	COLOR: blue; TEXT-DECORATION: underline
}
A:hover {
	COLOR: red; TEXT-DECORATION: underline
}
IMG {
	BORDER-BOTTOM-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px; BORDER-TOP-WIDTH: 0px
}
BODY {
	BACKGROUND-COLOR: #ffffff; COLOR: #000000; FONT-FAMILY: "宋体"; FONT-SIZE: 9pt; LINE-HEIGHT: 13pt; MARGIN-TOP: 10px
}
SMALL {
	FONT-SIZE: 9pt
}
TD {
	FONT-FAMILY: "宋体"; FONT-SIZE: 9pt; LINE-HEIGHT: 13pt
}
.BIGFONT {
	FONT-FAMILY: "宋体"; FONT-SIZE: 12pt; LINE-HEIGHT: 15pt
}
</STYLE>

<SCRIPT language=JavaScript>
<!--
function openNewWindow(theURL,winName,features) { //v2.0
  window.open(theURL,winName,features);
}
function openUserWindow(theURL)
{
	openNewWindow(theURL,'用户资料','scrollbars=yes,resizable=NO,width=660,height=400')
}
function openMessageWindow(theURL)
{
	openNewWindow(theURL,'留言','scrollbars=yes,resizable=NO,width=660,height=350')
}
function openDeleteWindow(theURL)
{
	openNewWindow(theURL,'删除主题','scrollbars=yes,resizable=NO,width=660,height=400')
}
function openBulletinWindow(theURL)
{
	openNewWindow(theURL,'论坛公告','scrollbars=yes,resizable=NO,width=660,height=300')
}
function openImageWindow(theURL)
{
	openNewWindow(theURL,'头像列表','scrollbars=yes,resizable=NO,width=660,height=350')
}

var cur_obj;
function dealAlphaMenu(o)
{
	var sobj,fobj,cur_alf,cmd;
	eval("sobj="+o+".style;");
	eval("fobj="+o+".filters;");
	if(o == cur_obj)
	{
		cur_alf = fobj.alpha.opacity;
		cur_alf +=45;
		fobj.alpha.opacity = cur_alf;
		cmd = "dealAlphaMenu('"+o+"')";
		if(cur_alf<90)
			window.setTimeout(cmd,200);
		else
			sobj.zIndex=2;
	}
}

function openSubMenu(o)
{
	var sobj,fobj,cmd;
	eval("sobj="+o+".style;");
	eval("fobj="+o+".filters;");
	if(sobj.visibility != "visible")
	{
		sobj.zIndex=3;
		sobj.visibility="visible";
		fobj.alpha.opacity =50;
		cmd = "dealAlphaMenu('"+o+"')";
		window.setTimeout(cmd,200);
	}
	cur_obj = o;
}
function closeSubMenu(o)
{
	var cmd
	cmd = "mycheck('"+o+"')";
	cur_obj=null;
	window.setTimeout(cmd,500);
}
function mycheck(o)
{
	var sobj;
	if(o != cur_obj)
	{
		eval("sobj="+o+".style;");
		sobj.visibility="hidden";
//		cur_obj =null;
	}
}

//-->
</SCRIPT>

<META content="MSHTML 5.00.3315.2870" name=GENERATOR></HEAD>
<BODY><!--包含头 -->
<TABLE align=center bgColor=#000000 border=0 cellPadding=3 cellSpacing=1 
width="96%"><!--标记放置区域-->
  <TBODY>
  <TR align=middle bgColor=#939393><!--图形LOGO标记放置区域-->
    <TD align=middle vAlign=center width="30%">
      <OBJECT classid=clsid:D27CDB6E-AE6D-11cf-96B8-444553540000 
      codeBase=http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=4,0,2,0 
      height=60 width=200><PARAM NAME="movie" VALUE="/vchelp/images/vc2.swf"><PARAM NAME="quality" VALUE="high">
                                                <embed 
      src="/vchelp/images/vc2.swf" quality=high 
      pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" 
      type="application/x-shockwave-flash" width="200" height="60">              
      </embed>             </OBJECT><!-- <img src=img/brand_200_60.gif width=200 height=60 alt="LOGO1">--></TD>
    <TD align=middle vAlign=center width="70%">
      <SCRIPT language=JavaScript 
      src="介绍一种巧妙的删除程序自己的方法.files/myads.htm"></SCRIPT>
    </TD></TR></TBODY></TABLE>
<P>
<TABLE align=center border=0 cellPadding=0 cellSpacing=0 width="96%">
  <TBODY>
  <TR>
    <TD align=middle vAlign=top width="20%"><!-- 左边导航 -->
      <TABLE bgColor=#000000 border=0 cellPadding=1 cellSpacing=1 
        width="100%"><TBODY>
        <TR bgColor=#939393>
          <TD><B><A href="http://www.vchelp.net/vchelp/vchelp.asp"><FONT 
            color=white>返回首页</FONT></A></B></TD></TR>
        <TR bgColor=#939393>
          <TD><B><FONT color=white>网站栏目导航</FONT></B></TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A 
            href="http://www.vchelp.net/vchelp/last.asp?class_id=1">VC++/MFC 
            Help</A><BR>提供各种VC++开发资源</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A 
            href="http://www.vchelp.net/vchelp/last.asp?class_id=2">VC#/dotNet 
            Help</A><BR>提供各种VC#开发资源</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/vchelp/last.asp?class_id=3">CE 
            eMbedded Help</A><BR>提供WinCE嵌入开发资源</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A 
            href="http://www.vchelp.net/vchelp/last.asp?class_id=4">开发有感</A><BR>供大家发表在开发中的感想，经验</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/cndevforum/cndevforum.asp" 
            target=_blank>开发论坛</A><BR>开发中遇到问题请在论坛中提出</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/copathway/copathway.asp" 
            target=_blank>合作开发</A><BR>让你通过网络与其他人进行合作</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/itbookreview/index.asp" 
            target=_blank>个人专栏</A><BR>供广大的朋友建立属于自己的专栏，发表自己的作品</TD></TR><!--<tr bgcolor=#F0F0F0><td><a href=/town/town.asp target=_blank>VCHelpTown</a><br>给你一个自己的家</td></tr>-->
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/chat/index.asp" 
            target=_blank>聊天室</A><BR>大家有空的时候来聊聊，交流一下</TD></TR>
        <TR bgColor=#f0f0f0>
          <TD><A href="http://www.vchelp.net/vchelp/about/submit.asp" 
            target=_blank>投稿指南</A><BR>为了VCHelp能够办得更好，我们需要你的支持</TD></TR>
        <TR bgColor=#939393>
          <TD><B><FONT color=white>网站搜索</FONT></B></TD></TR>
        <FORM action=/vchelp/search.asp method=get>
        <TR bgColor=#f0f0f0>
          <TD align=middle>搜索 <INPUT maxLength=20 name=terms size=10><BR>方式 
            <SELECT name=class_id size=1> <OPTION selected 
              value=1>搜索标题</OPTION> <OPTION value=2>搜索说明</OPTION></SELECT><BR>匹配 
            <SELECT name=and_search size=1> <OPTION selected 
              value=yes>所有条件</OPTION> <OPTION value=no>任一条件</OPTION></SELECT><BR><INPUT type=submit value=提交><INPUT name=reset type=reset value=重置> 
          </TD></TR></FORM>
        <TR bgColor=#939393>
          <TD><B><FONT color=white>订阅更新通知</FONT></B></TD></TR>
        <FORM action=../email_list/join.asp method=get target=_blank>
        <TR bgColor=#f0f0f0>
          <TD 
            align=middle>在订阅邮件后如果无<BR>法收到确认邮件则请<BR>换一个邮箱进行订阅<BR>输入邮件地址<BR><INPUT 
            maxLength=50 name=email_addr size=12><INPUT name=list_id type=hidden 
            value=1> <BR><INPUT CHECKED name=act type=radio value=join>加入 <INPUT 
            name=act type=radio value=exit>退出<BR><INPUT type=submit value=提交请求> 
          </TD></TR></FORM></TBODY></TABLE></TD>
    <TD width="1%"></TD>
    <TD align=left vAlign=top width="79%"><!--文章包含头 -->
      <P><A href="http://www.vchelp.net/vchelp/last.asp?class_id=1">Visual 
      C++开发</A>&gt;&gt;<A 
      href="http://www.vchelp.net/vchelp/last.asp?class_id=1&amp;c_id=2">平台/系统</A>&gt;&gt;<A 
      href="http://www.vchelp.net/vchelp/type.asp?class_id=1&amp;type_id=26">文件操作</A>&gt;&gt;本文被浏览次数 
      1469 <!--文章--><BR><BR>
      <TABLE align=center border=0 cellPadding=2 cellSpacing=0 width="100%">
        <TBODY>
        <TR bgColor=#939393>
          <TD align=middle width="100%"><FONT 
            color=white>介绍一种巧妙的删除程序自己的方法</FONT></TD></TR>
        <TR bgColor=#e6e6e6>
          <TD align=middle><A href="mailto:vcbear@china.com">vcbear</A> 投稿 
            2001/03/08 未经作者允许任何机构或个人不得以任何方式转载或复制本文</TD></TR>
        <TR bgColor=#f4f4f4>
          <TD><!--article begin-->
            <P align=center>介绍一种巧妙的删除程序自己的方法 </P>
            <P><A href="mailto:vcbear@china.com">vcbear</A> </P>
            <P></P>
            <P>近日看到网友询问如何实现程序运行之后把自己删除的方法，不知大家对木马甚么的兴趣实在太浓,还是想要这样的效果:用户只要一运行程序,可执行文件就没有了,可是程序还是在跑,胆小的只怕要喊"鬼呀!","老婆,快出来看上帝"甚么的。其实最典型的用法是写反安装程序. 
            闲来无事，Bear掰到一种还算巧妙的“删除自己”的方法。</P>
            <P></P>
            <P>大家都知道，一般的程序运行的时候，可执行文件本身是被操作系统保护的，不能用改写的方式访问，更别提在本身还在运行的时侯删除自己了。在Lu0的主页上看到一种UNDOCUMENT的方法，通过改变系统底层的文件访问模式实现删除自己，那是实在功夫。我看了很是佩服。但是有没有一种用在MSDN上就能查到的函数实现呢？有!Jeffrey 
            Richter给我们做了一个范例：</P>
            <P></P>
            <P>DeleteMe.CPP</P>
            <P></P>
            <P>Module name: DeleteMe.cpp</P>
            <P>Written by: Jeffrey Richter</P>
            <P>Description: Allows an EXEcutable file to delete itself</P>
            <P>********************************************************************/</P>
            <P></P>
            <P>#include &lt;Windows.h&gt;</P>
            <P>#include &lt;stdlib.h&gt;</P>
            <P>#include &lt;tchar.h&gt;</P>
            <P></P>
            <P>/////////////////////////////////////////////////////////////////////</P>
            <P></P>
            <P>int WINAPI WinMain(HINSTANCE h, HINSTANCE b, LPSTR psz, int n) 
            {</P>
            <P></P>
            <P>// Is this the Original EXE or the clone EXE?</P>
            <P>// If the command-line 1 argument, this is the Original EXE</P>
            <P>// If the command-line &gt;1 argument, this is the clone EXE</P>
            <P></P>
            <P>if (__argc == 1) {</P>
            <P></P>
            <P>// Original EXE: Spawn clone EXE to delete this EXE</P>
            <P>// Copy this EXEcutable image into the user's temp directory</P>
            <P></P>
            <P>TCHAR szPathOrig[_MAX_PATH], szPathClone[_MAX_PATH];</P>
            <P>GetModuleFileName(NULL, szPathOrig, _MAX_PATH);</P>
            <P>GetTempPath(_MAX_PATH, szPathClone);</P>
            <P>GetTempFileName(szPathClone, __TEXT("Del"), 0, szPathClone); </P>
            <P>CopyFile(szPathOrig, szPathClone, FALSE);</P>
            <P></P>
            <P>//***注意了***: 
            <P>// Open the clone EXE using FILE_FLAG_DELETE_ON_CLOSE</P>
            <P>HANDLE hfile = CreateFile(szPathClone, 0, FILE_SHARE_READ, NULL, 
            OPEN_EXISTING, FILE_FLAG_DELETE_ON_CLOSE, NULL);</P>
            <P></P>
            <P>// Spawn the clone EXE passing it our EXE's process handle</P>
            <P>// and the full path name to the Original EXE file.</P>
            <P>TCHAR szCmdLine[512];</P>
            <P>HANDLE hProcessOrig = OpenProcess(SYNCHRONIZE, TRUE, 
            GetCurrentProcessId());</P>
            <P>wsprintf(szCmdLine, __TEXT("%s %d \"%s\""), szPathClone, 
            hProcessOrig, szPathOrig);</P>
            <P>STARTUPINFO si;</P>
            <P>ZeroMemory(&amp;si, sizeof(si));</P>
            <P>si.cb = sizeof(si);</P>
            <P>PROCESS_INFORMATION pi;</P>
            <P>CreateProcess(NULL, szCmdLine, NULL, NULL, TRUE, 0, NULL, NULL, 
            &amp;si, &amp;pi);</P>
            <P>CloseHandle(hProcessOrig);</P>
            <P>CloseHandle(hfile);</P>
            <P></P>
            <P>// This original process can now terminate.</P>
            <P>} else {</P>
            <P></P>
            <P>// Clone EXE: When original EXE terminates, delete it</P>
            <P>HANDLE hProcessOrig = (HANDLE) _ttoi(__targv[1]);</P>
            <P>WaitForSingleObject(hProcessOrig, INFINITE);</P>
            <P>CloseHandle(hProcessOrig);</P>
            <P>DeleteFile(__targv[2]);</P>
            <P>// Insert code here to remove the subdirectory too (if 
            desired).</P>
            <P></P>
            <P>// The system will delete the clone EXE automatically </P>
            <P>// because it was opened with FILE_FLAG_DELETE_ON_CLOSE</P>
            <P>}</P>
            <P>return(0);</P>
            <P>}</P>
            <P>　</P>
            <P>看懂了吗？</P>
            <P></P>
            <P>这一段程序思路很简单：不是不能在运行时直接删除本身吗？好，那么程序先复制（CLONE）一个自己，用复制品起动另一个进程，然后自己结束运行，则原来的EXE文件不被系统保护.这时由新进程作为杀手删除原来的EXE文件，并且继续完成程序其他的功能。</P>
            <P></P>
            <P>新进程在运行结束后，复制品被自动删除。这又是值得介绍的一个把戏了，注意：</P>
            <P>// Open the clone EXE using FILE_FLAG_DELETE_ON_CLOSE</P>
            <P>HANDLE hfile = CreateFile(szPathClone, 0, FILE_SHARE_READ, 
            NULL,OPEN_EXISTING, FILE_FLAG_DELETE_ON_CLOSE, NULL);</P>
            <P>这里面的FILE_FLAG_DELETE_ON_CLOSE标志,这个标志是告诉操作系统，当和这个文件相关的所有句柄都被关闭之后(包括上面这个CREATEFILE创建的句炳)，就把这个文件删除。几乎所有的临时文件在创建时，都指明了这个标志。</P>
            <P>另外要注意的是:在复制品进程对原始程序操刀之前,应该等待原进程退出.在这里用的是进程同步技术.用</P>
            <P>HANDLE hProcessOrig = OpenProcess(SYNCHRONIZE, 
            TRUE,GetCurrentProcessId());</P>
            <P>得到原进程句柄.SYNCHRONICE标志在NT下有效,作用是使OpenProcess得到的句柄可以做为同步对象.复制品进程用WaitForSingleObject函数进行同步,然后一个DeleteFile,以及进行其它销毁证据（Jeffrey说：比如删目录）的工作,打完收工！</P>
            <P></P>
            <P>程序是基于CONSOLE的，通过传入的参数确定是原始的进程还是复制品新进程，并且得到需要操作的目标文件的信息（主要是路径），复制品放在系统的TEMP目录（GetTempPath得到），你也可以随便找个你认为安全的地方（比如：WINDOWS\SYSTEM32等等）。</P>
            <P>这里面没有甚么深的技术.再看其他的一些实现删除自己的例子,比如说在进程退出前,用fwrite等方法输出一个.BAT文件,在里面写几句DEL,然后WINEXEC一下这个BAT文件即可.玩儿过DOS的虫虫大多都会。今天又学一招，爽。</P>2001.2.27(随便转载,只要不拿掉bear的名字:D) 
<!--article end--></TD></TR></TBODY></TABLE><!--文章 end--><!--文章尾含头 --></P></TD></TR></TBODY></TABLE>
<P 
align=center>特别说明，未经本站允许不得复制本站栏目和内容<BR>本站所提供所有资源都不作为商业用途，如果你违反本规定将自行承担所有责任<BR><A 
href="http://www.copathway.com/" title=页面执行时间：640.625ms>VCHelp</A>网站版权所有 
闻怡洋制作<BR>(c)1998-2003 All Rights Reserved </P><!-- 尾包含 --></BODY></HTML>
