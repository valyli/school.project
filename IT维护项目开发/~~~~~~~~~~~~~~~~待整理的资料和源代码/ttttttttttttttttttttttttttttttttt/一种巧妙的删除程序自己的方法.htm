<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0044)http://tzsvc.xiloo.com/doc/files/delself.htm -->
<HTML><HEAD><TITLE>宗胜的编程乐园--文档 <http://tzsvc.xiloo.com></TITLE><!-- #BeginTemplate "/Templates/index3_old.dwt" --><!-- #BeginEditable "doctitle" --><!-- #EndEditable -->
<META http-equiv=Content-Type content="text/html; charset=gb2312">
<STYLE type=text/css>A {
	COLOR: #000000; TEXT-DECORATION: none
}
A:hover {
	TEXT-DECORATION: underline
}
</STYLE>

<SCRIPT language=JAVASCRIPT>
<!-- 
var timerID = null;
var timerRunning = false;
function stopclock (){
if(timerRunning)
clearTimeout(timerID);
timerRunning = false;
}
function showtime () {
var now = new Date();
var hours = now.getHours();
var minutes = now.getMinutes();
var seconds = now.getSeconds()
var timeValue = "现在时间是: " + ((hours >12) ? hours -12 :hours)
timeValue += ((minutes < 10) ? ":0" : ":") + minutes
timeValue += ((seconds < 10) ? ":0" : ":") + seconds
timeValue += (hours >= 12) ? " P.M." : " A.M."
window.status = timeValue;
timerID = setTimeout("showtime()",1000);
timerRunning = true;
}
function startclock () {
stopclock();
showtime();
}
-->
</SCRIPT>

<SCRIPT language=JavaScript>
<!--
function MM_reloadPage(init) {  //reloads the window if Nav4 resized
  if (init==true) with (navigator) {if ((appName=="Netscape")&&(parseInt(appVersion)==4)) {
    document.MM_pgW=innerWidth; document.MM_pgH=innerHeight; onresize=MM_reloadPage; }}
  else if (innerWidth!=document.MM_pgW || innerHeight!=document.MM_pgH) location.reload();
}
MM_reloadPage(true);
// -->
</SCRIPT>

<META content="MSHTML 5.50.4134.100" name=GENERATOR></HEAD>
<BODY text=#000000 bgColor=#ffffff leftMargin=0 onload=startclock()>
<TABLE cellSpacing=0 cellPadding=0 width=772 border=0>
  <TBODY>
  <TR>
    <TD vAlign=top align=left bgColor=#ffffff>
      <TABLE height=8 cellSpacing=0 cellPadding=0 width=776 align=center 
      border=0>
        <TBODY>
        <TR>
          <TD width=311 bgColor=#ffffff height=11><FONT color=#ffffff>　
            <SCRIPT language=JavaScript> <!---
today=new Date();
var hours = today.getHours();
var minutes = today.getMinutes();
var seconds = today.getSeconds();
var timeValue = "<FONT COLOR=black>" + ((hours >12) ? hours -12 :hours); timeValue += ((minutes < 10) ? "<BLINK><FONT COLOR=black>:</FONT></BLINK>0" : "<BLINK><FONT COLOR=black>:</FONT></BLINK>") + minutes+"</FONT></FONT>";
timeValue += (hours >= 12) ? "<FONT COLOR=blue><I><B>pm</B></I></FONT>" : "<FONT COLOR=blue><B><I>am</I></B></FONT>";
function initArray(){
this.length=initArray.arguments.length
for(var i=0;i<this.length;i++)
this[i+1]=initArray.arguments[i] }
var d=new initArray("<font color=RED>星期日","<font color=black>星期一","<font color=black>星期二","<font color=black>星期三","<font color=black>星期四","<font color=black>星期五","<font color=GREEN>星期六"); document.write("<font color=black>",today.getYear(),"<font color=red>年","<font color=black>",today.getMonth()+1,"<font color=red>月","<font color=black>",today.getDate(),"<font color=red>日 </FONT>",d[today.getDay()+1]," ",timeValue); //--></SCRIPT>
             <FONT color=#000000 size=2>登录</FONT></FONT></TD>
          <TD vAlign=bottom align=right width=51 bgColor=#ffffff height=11><A 
            href="http://tzsvc.xiloo.com/index.htm"><IMG height=17 
            src="一种巧妙的删除程序自己的方法.files/head.jpg" width=51 border=0></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/mywriting/mywriting.htm"><FONT 
            color=#000000 size=2>作品</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 
            height=11><FONT color=#000000 size=2><A 
            href="http://tzsvc.xiloo.com/firststu/firststu.htm">新手</A></FONT></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/doc/doc.htm"><FONT color=#000000 
            size=2>文章</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/skill/dll.htm"><FONT color=#000000 
            size=2>技巧</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/book/vc.htm"><FONT color=#000000 
            size=2>教程</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/code/code.htm"><FONT color=#000000 
            size=2>源码</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/ks/ks.htm"><FONT color=#000000 
            size=2>考试</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/job/job.htm"><FONT color=#000000 
            size=2>求职</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/download/download.htm"><FONT 
            color=#000000 size=2>下载</FONT></A></TD>
          <TD vAlign=bottom align=middle width=36 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/virus/virus.htm"><FONT color=#000000 
            size=2>病毒</FONT></A></TD>
          <TD vAlign=bottom align=left width=56 bgColor=#e8ecf8 height=11><A 
            href="http://tzsvc.xiloo.com/programmer/programmer.htm"><FONT 
            color=#000000 size=2>人生</FONT></A></TD></TR></TBODY></TABLE></TD></TR>
  <TR>
    <TD vAlign=top align=left bgColor=#0070b0></TD></TR>
  <TR vAlign=bottom align=left>
    <TD>
      <TABLE cellSpacing=0 cellPadding=0 width=761 align=center border=0>
        <TBODY>
        <TR>
          <TD width=188 height=49><IMG height=67 
            src="一种巧妙的删除程序自己的方法.files/zititle.jpg" width=187></TD>
          <TD width=452 height=49><A 
            href="http://asiafriendfinder.com/go/f122344"><IMG height=67 src="" 
            width=450 align=absBottom border=0></A></TD>
          <TD width=121 height=49><FONT size=2><IFRAME border=0 
            src="一种巧妙的删除程序自己的方法.files/showlink.htm" frameBorder=0 width=120 
            scrolling=no height=60></IFRAME></FONT></TD></TR></TBODY></TABLE></TD></TR>
  <TR bgColor=#0070b0>
    <TD><FONT color=#ffffff size=2><FONT size=2>　|<A target=_blank 
      href="http://www.sn163.net/cgi-bin/bbs3000/bbs.cgi?id=200205011106"><FONT 
      color=#ffffff size=2>编程论坛</FONT></A>|<A target=_blank 
      href="http://www.sn163.net/cgi-bin/gb2000/gb.cgi?id=tangzs"><FONT 
      color=#ffffff size=2>请您留言</FONT></A>|</FONT><A target=_blank 
      href="mailto:tzs168@yahoo.com.cn"><FONT color=#ffffff 
      size=2>联系我们</FONT></A>|</FONT></TD></TR>
  <TR>
    <TD vAlign=top align=left>
      <TABLE cellSpacing=0 cellPadding=0 width=777 border=0>
        <TBODY>
        <TR>
          <TD vAlign=top align=middle width=165 bgColor=#e8ecf8 
            height=104><IMG height=60 src="一种巧妙的删除程序自己的方法.files/word.jpg" 
            width=140><BR><BR><FONT size=2><A 
            href="http://tzsvc.xiloo.com/other/new.htm">本站更新列表&gt;&gt;</A></FONT><BR><BR><FONT 
            size=2><A 
            href="http://tzsvc.xiloo.com/other/goodpage.htm">好站链接&gt;&gt;</A></FONT><BR></TD>
          <TD vAlign=top align=left width=12 height=104><IMG height=15 
            src="一种巧妙的删除程序自己的方法.files/mid_conner.gif" width=10></TD>
          <TD vAlign=top align=left width=600 height=104><!-- #BeginEditable "data" -->
            <TABLE cellSpacing=0 cellPadding=0 width=599 border=0>
              <TBODY>
              <TR>
                <TD><FONT 
                  size=2>日期:2002/6/2　　　　　　　　　　　　　　　　　　　　　　　　文章出处:VCHelp</FONT></TD></TR>
              <TR>
                <TD height=13><FONT 
              size=2>标题:<B>一种巧妙的删除程序自己的方法</B></FONT></TD></TR>
              <TR>
                <TD>&nbsp;</TD></TR>
              <TR>
                <TD vAlign=top align=left>
                  <P><FONT 
                  size=2>近日看到网友询问如何实现程序运行之后把自己删除的方法，不知大家对木马甚么的兴<BR>趣实在太浓,还是想要这样的效果:用户只要一运行程序,可执行文件就没有了,可是程序<BR>还是在跑,胆小的只怕要喊"鬼呀!","老婆,快出来看上帝"甚么的<BR>。其实最典型的用法是写反安装程序. 
                  闲来无事，Bear掰到一种还算巧妙的“删除自己<BR>”的方法。<BR>　<BR>大家都知道，一般的程序运行的时候，可执行文件本身是被操作系统保护的，不能用改<BR>写的方式访问，更别提在本身还在运行的时侯删除自己了。在Lu0的主页上看到一种UND<BR>OCUMENT的方法，通过改变系统底层的文件访问模式实现删除自己，那是实在功夫。我看 
                  <BR>了很是佩服。但是有没有一种用在MSDN上就能查到的函数实现呢？有!Jeffrey 
                  Richter<BR>给我们做了一个范例：<BR>　<BR>DeleteMe.CPP<BR>　<BR>Module 
                  name: DeleteMe.cpp<BR>Written by: Jeffrey 
                  Richter<BR>Description: Allows an EXEcutable file to delete 
                  itself<BR>**************************************************/<BR>　<BR>#include 
                  &lt;Windows.h&gt;<BR>#include &lt;stdlib.h&gt;<BR>#include 
                  &lt;tchar.h&gt;<BR>　<BR>/////////////////////////////////////////////////<BR>　<BR>int 
                  WINAPI WinMain(HINSTANCE h, HINSTANCE b, LPSTR psz, int n) 
                  {<BR>　 <BR>// Is this the Original EXE or the clone EXE?<BR>// 
                  If the command-line 1 argument, this is the Original EXE<BR>// 
                  If the command-line &gt;1 argument, this is the clone 
                  EXE<BR>　<BR>if (__argc == 1) {<BR>　<BR>// Original EXE: Spawn 
                  clone EXE to delete this EXE<BR>// Copy this EXEcutable image 
                  into the user's temp directory<BR>　<BR>TCHAR 
                  szPathOrig[_MAX_PATH], 
                  szPathClone[_MAX_PATH];<BR>GetModuleFileName(NULL, szPathOrig, 
                  _MAX_PATH);<BR>GetTempPath(_MAX_PATH, 
                  szPathClone);<BR>GetTempFileName(szPathClone, __TEXT("Del"), 
                  0, szPathClone);<BR>CopyFile(szPathOrig, szPathClone, 
                  FALSE);<BR>　<BR>//***注意了***:<BR>// Open the clone EXE using 
                  FILE_FLAG_DELETE_ON_CLOSE<BR>HANDLE hfile = 
                  CreateFile(szPathClone, 0, FILE_SHARE_READ, NULL, 
                  OPEN_EXISTI<BR>NG, FILE_FLAG_DELETE_ON_CLOSE, 
                  NULL);<BR>　<BR>// Spawn the clone EXE passing it our EXE's 
                  process handle<BR>// and the full path name to the Original 
                  EXE file.<BR>TCHAR szCmdLine[512];<BR>HANDLE hProcessOrig = 
                  OpenProcess(SYNCHRONIZE, TRUE, 
                  GetCurrentProcessId());</FONT></P>
                  <P><FONT size=2>wsprintf(szCmdLine, __TEXT("%s %d \"%s\""), 
                  szPathClone, hProcessOrig, szPat<BR>hOrig);<BR>STARTUPINFO 
                  si;<BR>ZeroMemory(&amp;si, sizeof(si));<BR>si.cb = 
                  sizeof(si);<BR>PROCESS_INFORMATION pi;<BR>CreateProcess(NULL, 
                  szCmdLine, NULL, NULL, TRUE, 0, NULL, NULL, &amp;si, 
                  &amp;pi);<BR>CloseHandle(hProcessOrig);<BR>CloseHandle(hfile);<BR>　<BR>// 
                  This original process can now terminate.<BR>} else 
                  {<BR>　<BR>// Clone EXE: When original EXE terminates, delete 
                  it<BR>HANDLE hProcessOrig = (HANDLE) 
                  _ttoi(__targv[1]);<BR>WaitForSingleObject(hProcessOrig, 
                  INFINITE);<BR>CloseHandle(hProcessOrig);<BR>DeleteFile(__targv[2]);<BR>// 
                  Insert code here to remove the subdirectory too (if 
                  desired).<BR>　<BR>// The system will delete the clone EXE 
                  automatically<BR>// because it was opened with 
                  FILE_FLAG_DELETE_ON_CLOSE<BR>}<BR>return(0);<BR>}<BR>　<BR>看懂了吗？<BR>　<BR>这一段程序思路很简单：不是不能在运行时直接删除本身吗？好，那么程序先复制（CL<BR>ONE）一个自己，用复制品起动另一个进程，然后自己结束运行，则原来的EXE文件不被<BR>系统保护.这时由新进程作为杀手删除原来的EXE文件，并且继续完成程序其他的功能。</FONT></P>
                  <P><FONT size=2>　<BR>新进程在运行结束后，复制品被自动删除。这又是值得介绍的一个把戏了，注意： 
                  <BR>// Open the clone EXE using 
                  FILE_FLAG_DELETE_ON_CLOSE<BR>HANDLE hfile = 
                  CreateFile(szPathClone, 0, FILE_SHARE_READ, 
                  NULL,OPEN_EXISTIN<BR>G, FILE_FLAG_DELETE_ON_CLOSE, 
                  NULL);<BR>这里面的FILE_FLAG_DELETE_ON_CLOSE标志,这个标志是告诉操作系统，当和这个文件相<BR>关的所有句柄都被关闭之后(包括上面这个CREATEFILE创建的句炳)，就把这个文件删除<BR>。几乎所有的临时文件在创建时，都指明了这个标志。<BR>另外要注意的是:在复制品进程对原始程序操刀之前,应该等待原进程退出.在这里用的是<BR>进程同步技术.用<BR>HANDLE 
                  hProcessOrig = OpenProcess(SYNCHRONIZE, 
                  TRUE,GetCurrentProcessId());<BR>得到原进程句柄.SYNCHRONICE标志在NT下有效,作用是使OpenProcess得到的句柄可以做<BR>为同步对象.复制品进程用WaitForSingleObject函数进行同步,然后一个DeleteFile,以<BR>及进行其它销毁证据（Jeffrey说：比如删目录）的工作,打完收工！<BR>　<BR>程序是基于CONSOLE的，通过传入的参数确定是原始的进程还是复制品新进程，并且得到<BR>需要操作的目标文件的信息（主要是路径），复制品放在系统的TEMP目录（GetTempPat<BR>h得到），你也可以随便找个你认为安全的地方（比如：WINDOWS\SYSTEM32等等）。<BR>这里面没有甚么深的技术.再看其他的一些实现删除自己的例子,比如说在进程退出前,用<BR>fwrite等方法输出一个.BAT文件,在里面写几句DEL,然后WINEXEC一下这个BAT文件即可.<BR>玩儿过DOS的虫虫大多都会。今天又学一招，爽。</FONT></P>
                  <P></P></TD></TR>
              <TR>
                <TD align=middle><FONT size=2>上一页 第0页 下一页</FONT></TD></TR>
              <TR>
                <TD align=middle><FONT size=2><INPUT onclick=history.go(-1) type=button value=后退 name=button> 
<INPUT onclick=history.go(1) type=button value=前进 name=button2> 
<INPUT onclick=window.close() type=button value=关闭 name=button3> 
                  </FONT></TD></TR></TBODY></TABLE><!-- #EndEditable --></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE>
<TABLE cellSpacing=0 cellPadding=0 width=764 align=center border=0>
  <TBODY>
  <TR>
    <TD>
      <HR SIZE=1>
    </TD></TR>
  <TR>
    <TD align=middle><FONT size=2>Copyright(C)2002 
      宗胜的编程乐园　http://tzsvc.xiloo.com <BR>文章版权归原作者所有，如仍有问题，请与我联系 </FONT></TD></TR>
  <TR>
    <TD>
      <HR SIZE=1>
    </TD></TR></TBODY></TABLE><!-- #EndTemplate --></BODY></HTML>
